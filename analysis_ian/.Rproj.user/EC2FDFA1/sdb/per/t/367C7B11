{
    "contents" : "source(\"data-cleaning.R\")\nlibrary(HIVBackCalc)\nlibrary(reshape2)\nlibrary(ggplot2)\nlibrary(scales)\n#N\nn <- dim(msm)[1]\nn\n\n#HIS\nn-sum(is.na(msm[is.na(msm$everTested) || msm$everTested,]$lagHIV_HISNeg))\n\n#EHARS\nn-sum(is.na(msm[is.na(msm$everTested) || msm$everTested,]$lagHIV_LastNegEhars))\n\n\n#PCRS\nn-sum(is.na(msm[is.na(msm$everTested) || msm$everTested,]$lagHIV_LastNegPCRSrpt))\n\n#cors\ncor(msm[c(\"lagHIV_HISNeg\",\"lagHIV_LastNegEhars\",\"lagHIV_LastNegPCRSrpt\")],use=\"pair\")\n\n#never tested\nsum(!is.na(msm$everTested) & !msm$everTested)\n\n#combined\ntable(is.na(msm$infPeriod))\n\n#stability of time to dx\nby(msm$infPeriod,msm$yearDx,function(a)mean(a,na.rm=T))\nmean(msm$infPeriod,na.rm=T)\noneway.test(infPeriod ~ yearDx,data=msm)\n\n#Race\ntable(msm$racel)\nmsm$race2 <- as.character(msm$racel)\nmsm$race2[msm$race2 %in% c(\"4PI\",\"5AmInd\",\"6Multi\")] <- \"4OtherMulti\"\nmsm$race2 <- factor(msm$race2)\nlevels(msm$race2) <- c(\"Caucasian\",\"African American\",\"Hispanic\",\"Asian\",\"Other/Multi\")\ntable(msm$race2)\nby(msm,msm$race2,function(x)mean(x$infPeriod,na.rm=T))\n\npdf(\"plots/race.pdf\",width=6,height=3)\np <- ggplot(aes(y=infPeriod,x=race2),data=msm) + \n  geom_violin(adjust=3,fill=\"grey83\",color=NA) + \n  stat_summary(color=\"darkred\",fun.data = \"mean_cl_boot\") +\n  ylab(\"Years Since Last Negative\") +\n  xlab(\"\") +\n  theme_bw() +\n  coord_flip()\nplot(p)\ndev.off()\n\nrace <- \"\"\n#race <- \"Caucasian\"\n#race <- \"African American\"\n#race <- \"Hispanic\"\n#race <- \"Asian\"\n#race <- \"Other\"\nif(race!=\"\"){\n  tmp <- race\n  if(race == \"Other\"){\n    tmp <- \"Other/Multi\"\n  }\n  msm <- msm[msm$race2==tmp,]\n}\n\n#Plot distributions\nti <- sort(msm$infPeriod[!is.na(msm$infPeriod) & msm$infPeriod > 0])\nnUB <- length(ti)\nqUB <- function(u) {\n  uind <- sum(ti<=u)/nUB\n  if (is.na(uind)) \n    return(0)\n  uind\n}\npi <- function(i, eta, ti = ti) {\n  sapply(i, function(ii) {\n    ints <- ti[ti >= ii]\n    sum(1/ints)/length(ti)\n  })\n}\nuti <- unique(ti)\np <- pi(uti, , ti) * diff(c(0, uti))\ncs <- cumsum(p)\nqi <- function(u) {\n  uind <- rev(which(uti <= u))[1]\n  if (is.na(uind)) \n    return(0)\n  cs[uind]\n}\ns <- seq(from=0,to=20,length.out=500)\nest <- sapply(s,qi)\nub <- sapply(s,qUB)\nd1 <- rbind(data.frame(var=\"Base Case  \",value=est,Time=s),\n            data.frame(var=\"Upper Bound  \",value=ub,Time=s)\n)\npdf(paste0(\"plots/dist\",race,\".pdf\"),width=5,height=3)\np <- ggplot(d1) + geom_line(aes(x=Time,y=1-value,color=var)) + \n  scale_color_hue(name=\"\") +\n  theme_bw() + \n  ylab(\"Undiagnosed Fraction\") +\n  xlab(\"Time Since Infection\") +\n  scale_x_continuous(expand=c(0,.2)) +\n  theme(legend.position=\"bottom\")\nprint(p)\ndev.off()\n\n\n\n#estimated\nintLength <- .25\ny <- c(rep(NA,100),table(msm$timeDx))\npid <- estimateProbDist(infPeriod=msm$infPeriod,intLength=intLength)\nmod <- estimateIncidence(y,pid,gamma=.1,verbose=TRUE,tol=10^-4)\n#plot(mod,time=c(2006,2012.75))\n\nundiag <- estimateUndiagnosed(mod)\nobs <- !is.na(y)\ntime <- c(2006,2012.75)\ntime <- seq(from=time[1],to=time[2],length.out=sum(obs))\n#plot(time,undiag[obs],ylim=c(300,400),type=\"l\")\n\nti <- with(msm,sort(infPeriod[!is.na(infPeriod) & infPeriod>0]))\nmean(y,na.rm=TRUE) * mean(ti/2)*12/4\n\n\n#upper bound\nempirProbDist <- function(infPeriod,intLength=1){\n  ti <- sort(infPeriod[!is.na(infPeriod) & infPeriod > 0])\n  n <- length(ti)\n  qi <- function(u) {\n    uind <- sum(ti<=u)/n\n    if (is.na(uind)) \n      return(0)\n    uind\n  }\n  pidCalc <- function(i) {\n    sapply(i, function(ii) {\n      qi((ii + 1) * intLength) - qi(ii * intLength)\n    })\n  }\n  m <- max(ti/intLength) + 1\n  pidProbs <- pidCalc(0:m)\n  pid <- function(i) {\n    ifelse(i > m, 0, pidProbs[i + 1])\n  }\n  pid\n}\ny <- c(rep(NA,100),table(msm$timeDx))\npidUB <- empirProbDist(infPeriod=msm$infPeriod,intLength=intLength)\nmodUB <- estimateIncidence(y,pidUB,gamma=.1,verbose=TRUE,tol=10^-4)\n#plot(modUB,time=c(2006,2012.75))\n\nundiagUB <- estimateUndiagnosed(modUB)\nobs <- !is.na(y)\ntime <- c(2006,2012.75)\ntime <- seq(from=time[1],to=time[2],length.out=sum(obs))\n#plot(time,undiagUB[obs],ylim=c(300,800),type=\"l\")\n\nd <- rbind(\n  data.frame(time=time,var=\"# Diagnosed  \",value=y[obs]),\n  data.frame(time=time,var=\"Incidence (Base Case)  \",value=mod$lambda[obs]),\n  data.frame(time=time,var=\"Incidence (Upper Bound)  \",value=modUB$lambda[obs])\n)\nby(d$value,d$var,summary)\n\npdf(paste0(\"plots/inc\",race,\".pdf\"),height=5)\np <- ggplot(d,aes(x=time,y=value,linetype=var))  +   \n  geom_line(aes(alpha=var)) +\n  geom_point(aes(color=var)) + \n  theme_bw() + \n  scale_alpha_manual(values=c(.5,1,1),name=\"\") + \n  scale_color_hue(name=\"\") + \n  scale_linetype_manual(name=\"\",values=c(3,1,2)) + \n  xlab(\"Time\") + ylab(\"Counts\") + ylim(c(0,75)) +\n  theme(legend.position=\"bottom\")\nprint(p)\ndev.off()\n\nd1 <- rbind(\n  data.frame(time=time,var=\"Base Case  \",value=undiag[obs]),\n  data.frame(time=time,var=\"Upper Bound  \",value=undiagUB[obs])\n)\ncols <- hue_pal()(3)[-1]\npdf(paste(\"plots/undiag\",race,\".pdf\"),height=5)\np <- ggplot(d1,aes(x=time,y=value,linetype=var))  +   \n  geom_line() +\n  geom_point(aes(color=var)) + \n  theme_bw() + \n  scale_color_manual(name=\"\",values=cols) + \n  scale_linetype(name=\"\") + \n  xlab(\"Time\") + ylab(\"# Undiagnosed HIV+\") + ylim(c(0,750)) +\n  theme(legend.position=\"bottom\")\nprint(p)\ndev.off()\n\n#Count ranges\nby(d1$value,d1$var,summary)\n\n\n#constant incidence models\nincidence <- mean(y[obs])\n\nk <- 10000\nm <- max(ti)\ns <- seq(from=0,to=m,length.out=k)\nl <- length(ti)\nv <- sum(sapply(s,function(x) (sum(1-qi(x)))))\nv * 4 * incidence / (k/m)\n\n\nv <- sum(sapply(s,function(x) (sum(1-qUB(x)))))\nv * 4 * incidence / (k/m)\n\n\n\n",
    "created" : 1368725402392.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2095372947",
    "id" : "367C7B11",
    "lastKnownWriteTime" : 1382041987,
    "path" : "~/Consult/undiagnosed_hiv/analysis/run.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}