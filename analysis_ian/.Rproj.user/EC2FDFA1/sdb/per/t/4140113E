{
    "contents" : "source(\"data-cleaning.R\")\nlibrary(ggplot2)\nlibrary(reshape2)\nlibrary(MASS)\n\nby(msm,msm$yearDx,function(x)mean(x$infPeriod,na.rm=T))\noneway.test(infPeriod~yearDx,data=msm)\n\n#blacks and asians have less frequent tests\nby(msm,msm$racel,function(x)mean(x$infPeriod,na.rm=T))\ntable(msm$racel)\noneway.test(infPeriod~racel,data=msm)\nggplot(aes(y=infPeriod,x=factor(racel)),data=msm) + \n  geom_jitter(alpha=.25) + \n  geom_boxplot(color=\"darkred\",fill=NA,outlier.size=0)\n\n\nby(msm,paste(msm$racel,msm$yearDx),\n   FUN=function(x)c(mean(x$infPeriod,na.rm=T),sum(!is.na(x$infPeriod)))\n)\n\n\n#blacks + asians more likely to never have been tested\nx <- xtabs(~ racel + everTested,data=msm)\nx / rowSums(x)\nchisq.test(x,simulate=T)\n\n\n#exponential fit\nlastTest <- na.omit(msm$infPeriod)\ndst <- dexp\nfit <- fitdistr(lastTest, \"exponential\")\nxFit <- seq(from = 0, to = max(lastTest), length.out = 500)\nyFit <- do.call(dst, c(as.list(fit$estimate), list(x = xFit)))\nggplot() + geom_density(aes(x = lastTest)) + geom_line(aes(x = xFit, y = yFit), \n                                                       color = \"red\")\n\n\n#exponential fit (non-aids at dx)\nlastTest <- na.omit(msm$infPeriod[!msm$aidsAtDx])\ndst <- dexp\nfit <- fitdistr(lastTest, \"exponential\")\nxFit <- seq(from = 0, to = max(lastTest), length.out = 500)\nyFit <- do.call(dst, c(as.list(fit$estimate), list(x = xFit)))\nggplot() + geom_density(aes(x = lastTest)) + geom_line(aes(x = xFit, y = yFit), \n                                                       color = \"red\")\n\n\n\n\n#\n# Upper bounds on AIDS incubation periods evaluated using those who are diagnosed with AIDS at HIV\n# diagnosis\n#\nmsm1 <- msm[msm$aidsAtDx,]\nmsm1$infPeriodHe <- pmin(msm1$lagHIV_LastNegEhars,msm1$lagHIV_HISNeg,na.rm=TRUE) / 365\nmsm1$infPeriodHe <- with(msm1,ifelse(is.na(ungtst) & ungtst==\"N\",hiv_age_yrs-15,infPeriodHe))\nmsm1$infPeriodUB <- with(msm1,ifelse(is.na(infPeriod),hiv_age_yrs-15,infPeriodHe))\nmean(msm1$hiv_age_yrs)\nmsm1 <- msm1[c(\"infPeriodHe\",\"infPeriodUB\",\"lagHIV_LastNegEhars\",\"lagHIV_LastNegPCRSrpt\",\"lagHIV_HISNeg\")]\nmsm1[3:5] <- msm1[c(3:5)]/365\nplot(msm1,xlim=c(0,30),ylim=c(0,30))\ncor(msm1,use=\"pair\")\n\nnrow(msm1)\nsummary(msm1)\nm <- melt(msm1[-c(2,4)])\nggplot(aes(x=value,color=variable),data=m) + \n  stat_function(fun = dweibull, colour = \"grey50\", arg = list(shape=2.516,scale=1/0.086), size=2) + \n  annotate(\"text\", x = 17, y = .092, label = \"Wiebull(shape=2.516,scale=11.628)\",color=\"grey50\") +\n  geom_density(adjust=2.25,na.rm=TRUE) + \n  xlim(c(0,30)) + \n  theme_bw() + \n  scale_color_discrete(\"Report\",labels=c(\"Combined\",\"EHARS\",\"HIS\")) + \n  xlab(\"Years since last negative HIV test\") + \n  ylab(\"Density\")\n\ns <- 1:300 / 10\na <- data.frame(a=ecdf(msm1[[1]])(s),b=ecdf(msm1[[3]])(s),\n                c=ecdf(msm1[[4]])(s))\nm1 <- melt(a)\nggplot(aes(x=rep(s,3),y=value,color=variable),data=m1) + \n  stat_function(fun = pweibull, colour = \"grey50\", arg = list(shape=2.516,scale=1/0.086), size=2) + \n  annotate(\"text\", x = 17, y = .092, label = \"Wiebull(shape=2.516,scale=11.628)\",color=\"grey50\") +\n  geom_step() + \n  xlim(c(0,30)) + \n  theme_bw() + \n  scale_color_discrete(\"Report\",labels=c(\"Combined\",\"EHARS\",\"HIS\")) + \n  xlab(\"Years since last negative HIV test\") + \n  ylab(\"Proportion without AIDS\")\n\nmedConf <- function(x){\n  x <- na.omit(x)\n  ul <- sort(x)[qbinom(c(.025,.975), length(x), 0.5)]\n  c(median = median(x),lower=ul[1],upper=ul[2])\n}\nsapply(msm1,medConf)\n\n\n#\n# Use pcrs and create hard upper bound assuming all missings have never been tested before.\n#\nmsm1 <- msm[msm$aidsAtDx & msm$timeDx>=2010,]\nmsm1$infPeriodHe <- msm1$infPeriod\nmsm1$infPeriodUB <- with(msm1,ifelse(is.na(infPeriod),hiv_age_yrs-15,infPeriodHe))\nmean(msm1$hiv_age_yrs)\nmsm1 <- msm1[c(\"infPeriodHe\",\"infPeriodUB\",\"lagHIV_LastNegEhars\",\"lagHIV_LastNegPCRSrpt\",\"lagHIV_HISNeg\")]\nmsm1[3:5] <- msm1[c(3:5)]/365\nplot(msm1,xlim=c(0,30),ylim=c(0,30))\ncor(msm1,use=\"pair\")\n\nnrow(msm1)\nsummary(msm1)\nm <- melt(msm1[-2])\nggplot(aes(x=value,color=variable),data=m) + \n  stat_function(fun = dweibull, colour = \"grey50\", arg = list(shape=2.516,scale=1/0.086), size=2) + \n  annotate(\"text\", x = 17, y = .092, label = \"Wiebull(shape=2.516,scale=11.628)\",color=\"grey50\") +\n  geom_density(adjust=2.25,na.rm=TRUE) + \n  xlim(c(0,30)) + \n  theme_bw() + \n  scale_color_discrete(\"Report\",labels=c(\"Combined\",\"EHARS\",\"PCRS\",\"HIS\")) + \n  xlab(\"Years since last negative HIV test\") + \n  ylab(\"Density\")\n\ns <- 1:300 / 10\na <- data.frame(a=ecdf(msm1[[1]])(s),b=ecdf(msm1[[3]])(s),\n                c=ecdf(msm1[[4]])(s),d=ecdf(msm1[[5]])(s))\nm1 <- melt(a)\nggplot(aes(x=rep(s,4),y=value,color=variable),data=m1) + \n  stat_function(fun = pweibull, colour = \"grey50\", arg = list(shape=2.516,scale=1/0.086), size=2) + \n  annotate(\"text\", x = 17, y = .15, label = \"Wiebull(shape=2.516,scale=11.628)\",color=\"grey50\") +\n  geom_step() + \n  xlim(c(0,30)) + \n  theme_bw() + \n  scale_color_discrete(\"Report\",labels=c(\"Combined\",\"EHARS\",\"PCRS\",\"HIS\")) + \n  xlab(\"Years since last negative HIV test\") + \n  ylab(\"Proportion without AIDS\")\n\nsapply(msm1,medConf)\n\n\n\n",
    "created" : 1368117778953.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2176709913",
    "id" : "4140113E",
    "lastKnownWriteTime" : 1371232538,
    "path" : "~/Consult/undiagnosed_hiv/analysis/descriptives.R",
    "properties" : {
        "notebook_author" : "ianfellows",
        "notebook_title" : "descriptives.R",
        "notebook_type" : "spin",
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}